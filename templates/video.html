<!DOCTYPE html>
<html>

<head>
    <title>Videos</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#ffffff">
    <meta name="color-scheme" content="light">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
    <style>
        /* Base styles inherited from the app theme */
        :root {
            --bg: #f6f7fb;
            --text: #0f172a;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --shadow: 0 8px 20px rgba(2, 8, 23, 0.06);
            --accent: #3b82f6;
            --success: #10b981;
            --danger: #ef4444;
            --muted: #64748b;
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            background: radial-gradient(1200px 600px at 50% -200px, #eef2ff 0%, var(--bg) 60%);
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            padding: 24px;
        }

        .site-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 50;
            backdrop-filter: saturate(180%) blur(8px);
            -webkit-backdrop-filter: saturate(180%) blur(8px);
            background: rgba(255, 255, 255, 0.6);
            border-bottom: 1px solid rgba(226, 232, 240, 0.7);
        }

        .header__inner {
            max-width: 1100px;
            margin: 0 auto;
            padding: 12px 20px;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 12px;
        }

        .header__actions {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            grid-column: 2;
            overflow-x: auto;
            white-space: nowrap;
        }

        .nav__link {
            position: relative;
            display: inline-block;
            height: 20px;
            overflow: hidden;
            color: inherit;
            text-decoration: none;
            font-weight: 600;
            background: transparent;
            border: 0;
            padding: 0;
            cursor: pointer;
            font-size: 1rem;
        }

        .link__text {
            display: block;
            line-height: 20px;
            transition: transform 220ms ease;
        }

        .link__text--hover {
            position: absolute;
            left: 0;
            top: 100%;
            opacity: 0.9;
        }

        .nav__link:hover .link__text--primary {
            transform: translateY(-100%);
        }

        .nav__link:hover .link__text--hover {
            transform: translateY(-100%);
            opacity: 1;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .page {
            max-width: 1100px;
            margin: 46px auto 0;
            width: 100%;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .page-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        .icon-button {
            appearance: none;
            border: 0;
            padding: 8px;
            border-radius: 999px;
            background: var(--card-bg);
            box-shadow: var(--shadow);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .deck-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        @media (min-width: 640px) {
            .deck-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1024px) {
            .deck-grid {
                grid-template-columns: 1fr 1fr 1fr;
            }
        }

        #explanationContainer {
            margin-top: 16px;
            padding: 16px 20px;
            background: #ffffff;
            border-radius: 14px;
            border: 1px solid var(--card-border);
            box-shadow: var(--shadow);
            height: 800px;
            overflow-y: auto;
            text-align: left;
        }

        .explanation-list {
            list-style-type: disc;
            padding-left: 20px;
            margin: 0;
            color: var(--text);
            font-size: 1.05rem;
            line-height: 1.6;
        }

        .explanation-list li {
            margin-bottom: 8px;
        }

        .explanation-list li:last-child {
            margin-bottom: 0;
        }

        .explanation-empty {
            list-style: none;
            color: var(--muted);
            font-size: 0.95rem;
            text-align: center;
            padding: 8px 0;
        }

        .deck-tile {
            position: relative;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 14px;
            padding: 16px 16px 10px;
            cursor: pointer;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .pdf-thumb-wrap {
            width: 100%;
            border-radius: 10px;
            overflow: hidden;
            background: #e5e7eb;
            margin-bottom: 8px;
            aspect-ratio: 16 / 9;
        }

        .pdf-thumb-img {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: cover;
        }

        .pdf-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 6px;
        }

        .pdf-card-title {
            flex: 1;
            font-size: 0.95rem;
            line-height: 1.25;
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            text-overflow: ellipsis;
            white-space: normal;
        }

        .kebab-btn {
            border: 0;
            background: transparent;
            padding: 4px;
            cursor: pointer;
            border-radius: 999px;
        }

        .kebab-menu {
            position: absolute;
            top: 32px;
            right: 0;
            min-width: 140px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            padding: 4px 0;
            display: none;
            z-index: 100;
            transform-origin: top right;
        }

        .kebab-menu.is-open {
            display: block;
            animation: menuFadeIn 0.15s ease-out forwards;
        }

        @keyframes menuFadeIn {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .kebab-menu button {
            width: 100%;
            padding: 8px 16px;
            border: 0;
            background: transparent;
            text-align: left;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
            transition: background 0.2s;
        }

        .kebab-menu button:hover {
            background: #f1f5f9;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .modal.is-open {
            display: flex;
        }

        .modal__backdrop {
            position: absolute;
            inset: 0;
            background: rgba(2, 8, 23, 0.5);
            backdrop-filter: blur(2px);
        }

        .modal__dialog {
            position: relative;
            width: 90%;
            max-width: 420px;
            background: var(--card-bg);
            border: 1px solid #e5e5f0;
            border-radius: 18px;
            padding: 18px 18px 16px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.20);
            z-index: 101;
        }

        .modal__title {
            margin: 0 0 16px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
        }

        .modal__field {
            margin-bottom: 12px;
        }

        .modal__field label {
            display: block;
            font-size: 0.72rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
            color: var(--muted);
            margin-bottom: 6px;
        }

        .modal__field input {
            width: 100%;
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--card-border);
            font-size: 0.95rem;
        }

        .upload-dropzone {
            width: 100%;
            border-radius: 18px;
            border: 1.5px dashed #d3d7e6;
            background: #f9fafb;
            padding: 22px 16px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .upload-dropzone-icon {
            width: 44px;
            height: 44px;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 6px;
            color: var(--accent);
        }

        .upload-dropzone-title {
            font-size: 0.95rem;
            font-weight: 500;
        }

        .upload-dropzone-filename {
            font-size: 0.78rem;
            color: var(--muted);
            margin-top: 4px;
        }

        .modal__actions {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 14px;
        }

        .btn {
            border-radius: 999px;
            border: 1px solid var(--card-border);
            padding: 8px 14px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            background: var(--card-bg);
        }

        .btn--primary {
            background: var(--accent);
            border-color: var(--accent);
            color: #ffffff;
        }

        .loading-overlay {
            position: fixed;
            inset: 0;
            z-index: 80;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.6);
        }

        .loading-overlay.is-active {
            display: flex;
        }

        /* Player View Styles */
        #playerView {
            display: none;
        }

        .video-container {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            position: relative;
        }

        .video-wrapper {
            position: relative;
            padding-bottom: 56.25%;
            /* 16:9 */
            height: 0;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
            background: #000;
        }

        .video-wrapper iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: 0;
        }

        .subtitles-container {
            margin-top: 24px;
            padding: 24px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: 16px;
            box-shadow: var(--shadow);
            text-align: center;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .subtitle-de {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 8px;
        }

        .subtitle-en {
            font-size: 1.1rem;
            color: var(--muted);
        }

        .player-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 16px;
            gap: 16px;
            position: relative;
        }

        .player-controls button {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            background: var(--accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            transition: transform 100ms ease, background 200ms ease;
        }

        .player-controls button svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        .player-controls button:active {
            transform: scale(0.95);
        }

        .player-controls .btn-secondary {
            background: var(--card-bg);
            color: var(--muted);
            box-shadow: var(--shadow);
            border: 1px solid var(--card-border);
        }

        .player-controls .btn-secondary:hover {
            color: var(--text);
            border-color: #cbd5e1;
        }

        .player-controls .btn-active {
            background: var(--accent) !important;
            color: white !important;
            border-color: var(--accent) !important;
        }

        .side-control-left {
            position: absolute;
            left: 0;
        }

        .side-control-right {
            position: absolute;
            right: 0;
        }

        #playerTitle {
            flex: 1;
            font-size: 1.25rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 1;
            line-clamp: 1;
            text-overflow: ellipsis;
            white-space: normal;
            margin-right: 12px;
        }
    </style>
</head>

<body>
    <header class="site-header" role="banner">
        <div class="header__inner">
            <div class="header__actions">
                <button class="nav__link nav__link--button" onclick="location.href='/'">
                    <span class="link__text link__text--primary">Home</span>
                    <span class="link__text link__text--hover" aria-hidden="true">Home</span>
                </button>
                <button class="nav__link nav__link--button" onclick="location.href='/create'">
                    <span class="link__text link__text--primary">Create </span>
                    <span class="link__text link__text--hover" aria-hidden="true">Create</span>
                </button>
                <button class="nav__link nav__link--button" onclick="location.href='/pdf'">
                    <span class="link__text link__text--primary">PDF</span>
                    <span class="link__text link__text--hover" aria-hidden="true">PDF</span>
                </button>
                <button class="nav__link nav__link--button" onclick="location.href='/video'">
                    <span class="link__text link__text--primary">Video</span>
                    <span class="link__text link__text--hover" aria-hidden="true">Video</span>
                </button>
            </div>
        </div>
    </header>

    <div class="loading-overlay is-active" id="globalLoader" aria-hidden="false"></div>

    <div class="page" id="listView">
        <div class="page-header">
            <h1 class="page-title">Videos</h1>
            <button class="icon-button" id="addVideoBtn"
                onclick="document.getElementById('addModal').classList.add('is-open')">
                <span class="material-symbols-outlined">add</span>
            </button>
        </div>
        <div class="deck-grid" id="videoGrid"></div>
    </div>

    <!-- Player View -->
    <div class="page" id="playerView">
        <div class="page-header">
            <div style="display:flex; align-items:center; gap: 12px; width: 100%;">
                <button class="icon-button" onclick="closePlayer()" style="flex-shrink: 0;">
                    <span class="material-symbols-outlined">arrow_back</span>
                </button>
                <h1 class="page-title" id="playerTitle">Video Title</h1>
                <button class="btn btn--secondary" id="retryTranslationBtn" onclick="retryTranslations()"
                    style="display:none; margin-left:auto; padding: 4px 12px; font-size: 0.85rem; flex-shrink: 0;">
                    <span class="material-symbols-outlined"
                        style="font-size: 18px; margin-right: 4px; vertical-align: middle;">translate</span>
                    Retry Missing
                </button>
            </div>
        </div>

        <div class="video-container">
            <div class="video-wrapper">
                <div id="ytplayer"></div>
            </div>

            <div class="subtitles-container">
                <div class="subtitle-de" id="subDe">...</div>
                <div class="subtitle-en" id="subEn">...</div>
                <button id="resumeBtn" onclick="resumeVideo()"
                    style="display:none; margin-top:12px; padding:8px 20px; border:none; background:var(--accent); color:white; border-radius:999px; font-size:0.9rem; font-weight:600; cursor:pointer; box-shadow: 0 2px 8px rgba(79,70,229,0.3);">
                    ▶ Resume
                </button>
            </div>

            <div class="player-controls">
                <button onclick="replayCurrentLine()" class="btn-secondary side-control-left" title="Replay Line">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8-3.58-8-8-8z" />
                    </svg>
                </button>
                <div style="display: flex; gap: 16px; align-items: center;">
                    <button onclick="jumpToPreviousLine()" title="Previous Line">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z" />
                        </svg>
                    </button>
                    <button onclick="togglePlayPause()" id="playPauseBtn" style="width: 60px; height: 60px;">
                        <svg viewBox="0 0 24 24" id="playIcon">
                            <path d="M8 5v14l11-7z" />
                        </svg>
                        <svg viewBox="0 0 24 24" id="pauseIcon" style="display: none;">
                            <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z" />
                        </svg>
                    </button>
                    <button onclick="jumpToNextLine()" title="Next Line">
                        <svg viewBox="0 0 24 24">
                            <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z" />
                        </svg>
                    </button>
                </div>
                <button onclick="toggleAutoStop()" id="autoStopBtn" class="btn-secondary side-control-right"
                    title="Auto Stop After Line">
                    <svg viewBox="0 0 24 24">
                        <path
                            d="M18 16h-2v-6h2v6zm-4-6h-2v6h2v-6zm3-4H7c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h10c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM7 18V8h10v10H7z" />
                    </svg>
                </button>
            </div>

            <div id="explanationContainer">
                <ul class="explanation-list" id="explanationList">
                    <li class="explanation-empty">Word breakdown will appear here</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Add Video Modal -->
    <div class="modal" id="addModal">
        <div class="modal__backdrop" onclick="document.getElementById('addModal').classList.remove('is-open')"></div>
        <div class="modal__dialog">
            <h2 class="modal__title">Add Video</h2>

            <div class="modal__field">
                <label>YouTube Link</label>
                <input type="text" id="videoUrl" placeholder="https://youtube.com/watch?v=...">
            </div>

            <div class="modal__field">
                <label>Title</label>
                <input type="text" id="videoTitle" placeholder="My German Video">
            </div>

            <input type="file" id="srtFile" accept=".srt" style="display:none">
            <div class="upload-dropzone" onclick="document.getElementById('srtFile').click()">
                <div class="upload-dropzone-icon">
                    <span class="material-symbols-outlined">subtitles</span>
                </div>
                <div class="upload-dropzone-title">Upload SRT File</div>
                <div class="upload-dropzone-filename" id="srtFilename">No file selected</div>
            </div>

            <div class="modal__actions">
                <button class="btn btn--primary" onclick="createVideo()" id="createBtn" style="margin-top: 12px;">Create
                    Video (with AI translation)</button>
            </div>
            <p id="modalStatus" style="color:var(--danger); font-size:0.8rem; text-align:center; margin-top:8px;"></p>
        </div>
    </div>

    <!-- YouTube IFrame API -->
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        const globalLoader = document.getElementById('globalLoader');
        const videoGrid = document.getElementById('videoGrid');

        // State
        let videos = [];
        let currentVideo = null;
        let player = null;
        let playTimer = null;

        // Subtitle tracking
        let activeSubtitleIdx = -1;
        let autoStopEnabled = false;
        let lastPlayedIdx = -1;
        let lastAutoStoppedIdx = -1;

        async function loadVideos() {
            try {
                const resp = await fetch('/videos');
                const data = await resp.json();
                videos = data.videos || [];
                renderGrid();
            } catch (err) {
                console.error("Failed to load videos:", err);
            } finally {
                globalLoader.classList.remove('is-active');
            }
        }

        function renderGrid() {
            videoGrid.innerHTML = '';
            if (!videos.length) {
                videoGrid.innerHTML = '<p style="color:var(--muted); padding:10px;">No videos yet.</p>';
                return;
            }

            videos.forEach(v => {
                const thumb = `https://img.youtube.com/vi/${v.youtube_id}/maxresdefault.jpg`;
                const isTranslating = v.translating;
                const tile = document.createElement('div');
                tile.className = 'deck-tile';
                if (isTranslating) {
                    tile.style.opacity = '0.7';
                }

                // Construct the click handler
                const clickHandler = isTranslating
                    ? `alert('This video is currently being translated in the background. Please check back in a minute!')`
                    : `openPlayer('${v.id}')`;

                tile.innerHTML = `
                    <div class="pdf-thumb-wrap" onclick="${clickHandler}" style="position: relative;">
                        <img src="${thumb}" class="pdf-thumb-img">
                        ${isTranslating ? '<div style="position:absolute; top:8px; left:8px; background:var(--accent); color:white; font-size:0.75rem; padding:4px 8px; border-radius:6px; font-weight:600; box-shadow:0 2px 4px rgba(0,0,0,0.2);">Translating AI...</div>' : ''}
                    </div>
                    <div class="pdf-card-header">
                        <div class="pdf-card-title">${v.title}</div>
                        <div style="position:relative;">
                            <button class="kebab-btn" onclick="toggleMenu(event, '${v.id}')">
                                <span class="material-symbols-outlined" style="font-size:20px">more_vert</span>
                            </button>
                            <div class="kebab-menu" id="menu-${v.id}">
                                ${isTranslating ? `
                                <button onclick="fixStuckVideo('${v.id}')" style="color:var(--accent)">
                                    <span class="material-symbols-outlined" style="font-size: 18px;">build</span>
                                    Fix Stuck
                                </button>
                                ` : ''}
                                <button onclick="deleteVideo('${v.id}')" style="color:var(--danger)">
                                    <span class="material-symbols-outlined" style="font-size: 18px;">delete</span>
                                    Delete
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                videoGrid.appendChild(tile);
            });
        }

        function toggleMenu(e, id) {
            e.stopPropagation();
            document.querySelectorAll('.kebab-menu').forEach(m => m.classList.remove('is-open'));
            document.querySelectorAll('.deck-tile').forEach(m => m.style.zIndex = '');
            const menu = document.getElementById(`menu-${id}`);
            if (menu) {
                const tile = menu.closest('.deck-tile');
                if (tile) tile.style.zIndex = '50';
                menu.classList.add('is-open');
            }
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.kebab-menu') && !e.target.closest('.kebab-btn')) {
                document.querySelectorAll('.kebab-menu').forEach(m => m.classList.remove('is-open'));
                document.querySelectorAll('.deck-tile').forEach(m => m.style.zIndex = '');
            }
        });

        // Upload handling
        const srtInput = document.getElementById('srtFile');
        let srtContent = '';

        const videoUrlInput = document.getElementById('videoUrl');
        const videoTitleInput = document.getElementById('videoTitle');
        const statusEl = document.getElementById('modalStatus');

        videoUrlInput.addEventListener('input', async (e) => {
            const url = e.target.value.trim();
            if (url && !videoTitleInput.value && (url.includes('youtube.com') || url.includes('youtu.be'))) {
                const oldText = statusEl.textContent;
                statusEl.textContent = "Fetching video title...";
                statusEl.style.color = "var(--muted)";

                try {
                    const fetchUrl = `https://www.youtube.com/oembed?url=${encodeURIComponent(url)}&format=json`;
                    const resp = await fetch(fetchUrl);
                    if (resp.ok) {
                        const data = await resp.json();
                        if (data && data.title) {
                            videoTitleInput.value = data.title;
                        }
                    }
                } catch (err) {
                    console.error("Failed to fetch YouTube title:", err);
                } finally {
                    if (statusEl.textContent === "Fetching video title...") {
                        statusEl.textContent = oldText;
                    }
                }
            }
        });

        srtInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                document.getElementById('srtFilename').textContent = file.name;
                const reader = new FileReader();
                reader.onload = (e) => { srtContent = e.target.result; };
                reader.readAsText(file);
            }
        });

        async function createVideo() {
            const url = document.getElementById('videoUrl').value;
            const title = document.getElementById('videoTitle').value;
            const status = document.getElementById('modalStatus');
            const btn = document.getElementById('createBtn');

            if (!url || !title || !srtContent) {
                status.textContent = "Please provide URL, Title, and SRT file.";
                return;
            }

            status.textContent = "Uploading video... Translation will run in background.";
            status.style.color = "var(--accent)";
            btn.disabled = true;

            try {
                const resp = await fetch('/videos', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        title: title,
                        youtube_url: url,
                        srt_content: srtContent
                    })
                });

                if (!resp.ok) {
                    const e = await resp.json();
                    throw new Error(e.detail || "Failed to create video");
                }

                document.getElementById('addModal').classList.remove('is-open');

                // Reset form
                document.getElementById('videoUrl').value = '';
                document.getElementById('videoTitle').value = '';
                srtContent = '';
                document.getElementById('srtFilename').textContent = 'No file selected';

                globalLoader.classList.add('is-active');
                await loadVideos();
            } catch (err) {
                status.textContent = err.message;
                status.style.color = "var(--danger)";
            } finally {
                btn.disabled = false;
            }
        }

        async function deleteVideo(id) {
            if (!confirm('Delete this video?')) return;
            globalLoader.classList.add('is-active');
            try {
                await fetch(`/videos/${id}`, { method: 'DELETE' });
                await loadVideos();
            } catch (err) {
                console.error(err);
                globalLoader.classList.remove('is-active');
            }
        }

        async function fixStuckVideo(id) {
            try {
                await fetch(`/videos/${id}/fix-stuck`, { method: 'POST' });
                await loadVideos();
            } catch (err) {
                console.error(err);
                alert('Failed to fix stuck badge.');
            }
        }

        // --- Player ---

        async function openPlayer(id) {
            globalLoader.classList.add('is-active');
            try {
                const resp = await fetch(`/videos/${id}`);
                const data = await resp.json();
                currentVideo = data;

                document.getElementById('listView').style.display = 'none';
                document.getElementById('playerView').style.display = 'block';
                document.getElementById('playerTitle').textContent = data.title;

                // Show the Retry Missing button if any line is missing its english translation or explanation chunks
                const hasMissingData = data.subtitles.some(s => !s.text_en || !s.chunks || s.chunks.length === 0);
                document.getElementById('retryTranslationBtn').style.display = hasMissingData ? 'block' : 'none';

                // Show Resume button if there is saved progress
                const resumeBtn = document.getElementById('resumeBtn');
                const saved = localStorage.getItem('video_progress_' + data.id);
                if (saved && parseFloat(saved) > 5) {
                    const mins = Math.floor(parseFloat(saved) / 60);
                    const secs = Math.floor(parseFloat(saved) % 60);
                    resumeBtn.textContent = `▶ Resume at ${mins}:${secs.toString().padStart(2, '0')}`;
                    resumeBtn.style.display = 'inline-block';
                    setTimeout(() => { resumeBtn.style.display = 'none'; }, 5000);
                } else {
                    resumeBtn.style.display = 'none';
                }

                initYouTubePlayer(data.youtube_id);
            } catch (err) {
                console.error(err);
            } finally {
                globalLoader.classList.remove('is-active');
            }
        }

        async function retryTranslations() {
            if (!currentVideo || !currentVideo.id) return;
            const btn = document.getElementById('retryTranslationBtn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = "Retrying in Background...";
            btn.disabled = true;

            try {
                const resp = await fetch(`/videos/${currentVideo.id}/retry`, { method: 'POST' });
                if (!resp.ok) throw new Error("Failed to retry translations");

                // Alert the user and close the player so the UI can accurately reflect the Translating state
                alert("Missing translations and explanations are being generated in the background! Please check back in a minute.");
                closePlayer();
                await loadVideos();
                startTranslatingPoll();
            } catch (err) {
                console.error(err);
                alert("Error retrying translations.");
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }
        function resumeVideo() {
            if (!player || !currentVideo) return;
            const saved = localStorage.getItem('video_progress_' + currentVideo.id);
            if (saved) {
                const t = parseFloat(saved);
                if (t > 0) player.seekTo(t, true);
            }
            document.getElementById('resumeBtn').style.display = 'none';
        }

        function closePlayer() {
            // Save progress before closing
            if (player && currentVideo && typeof player.getCurrentTime === 'function') {
                const t = player.getCurrentTime();
                if (t > 0) localStorage.setItem('video_progress_' + currentVideo.id, t.toFixed(1));
            }
            document.getElementById('listView').style.display = 'block';
            document.getElementById('playerView').style.display = 'none';
            if (player && typeof player.pauseVideo === 'function') {
                player.pauseVideo();
            }
            if (playTimer) clearInterval(playTimer);
            if (progressSaveTimer) { clearInterval(progressSaveTimer); progressSaveTimer = null; }
            document.getElementById('subDe').textContent = '...';
            document.getElementById('subEn').textContent = '...';
        }

        // YouTube API Ready callback
        let ytApiReady = false;
        function onYouTubeIframeAPIReady() {
            ytApiReady = true;
        }

        let progressSaveTimer = null;

        function initYouTubePlayer(videoId) {
            if (!ytApiReady) {
                setTimeout(() => initYouTubePlayer(videoId), 100);
                return;
            }

            const onReady = () => {
                // Player ready — resume button handles seeking if needed
            };

            if (player) {
                player.loadVideoById(videoId);
                // loadVideoById triggers onReady-like behavior after a short delay
                setTimeout(onReady, 500);
            } else {
                player = new YT.Player('ytplayer', {
                    videoId: videoId,
                    playerVars: {
                        'playsinline': 1,
                        'rel': 0,
                        'controls': 1
                    },
                    events: {
                        'onReady': onReady,
                        'onStateChange': onPlayerStateChange
                    }
                });
            }
        }

        function onPlayerStateChange(event) {
            const playIcon = document.getElementById('playIcon');
            const pauseIcon = document.getElementById('pauseIcon');

            if (event.data == YT.PlayerState.PLAYING) {
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
                if (!playTimer) {
                    // Update check rate to 30ms for tighter polling on subtitles/autostop
                    playTimer = setInterval(updateSubtitles, 30);
                }
                // Save progress every 5 seconds while playing
                if (!progressSaveTimer && currentVideo) {
                    progressSaveTimer = setInterval(() => {
                        if (player && currentVideo && typeof player.getCurrentTime === 'function') {
                            const t = player.getCurrentTime();
                            if (t > 0) localStorage.setItem('video_progress_' + currentVideo.id, t.toFixed(1));
                        }
                    }, 5000);
                }
            } else {
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
                if (playTimer) {
                    clearInterval(playTimer);
                    playTimer = null;
                }
                if (progressSaveTimer) {
                    clearInterval(progressSaveTimer);
                    progressSaveTimer = null;
                }
                // Save progress on pause
                if (player && currentVideo && typeof player.getCurrentTime === 'function') {
                    const t = player.getCurrentTime();
                    if (t > 0) localStorage.setItem('video_progress_' + currentVideo.id, t.toFixed(1));
                }
            }
        }

        function togglePlayPause() {
            if (!player) return;
            const state = player.getPlayerState();
            if (state === YT.PlayerState.PLAYING) {
                player.pauseVideo();
            } else {
                player.playVideo();
            }
        }

        function jumpToPreviousLine() {
            if (!player || !currentVideo || !currentVideo.subtitles) return;
            const subs = currentVideo.subtitles;
            const time = player.getCurrentTime();

            // Find which line we are currently on or just passed
            let currentLineIdx = -1;
            for (let i = subs.length - 1; i >= 0; i--) {
                if (time >= subs[i].start - 0.1) {
                    currentLineIdx = i;
                    break;
                }
            }

            // Always jump to the line before the current one
            if (currentLineIdx > 0) {
                lastAutoStoppedIdx = -1;
                player.seekTo(subs[currentLineIdx - 1].start);
            } else {
                player.seekTo(0);
            }
        }

        function jumpToNextLine() {
            if (!player || !currentVideo || !currentVideo.subtitles) return;
            const subs = currentVideo.subtitles;
            const time = player.getCurrentTime();

            for (let i = 0; i < subs.length; i++) {
                if (time < subs[i].start - 0.1) {
                    player.seekTo(subs[i].start);
                    return;
                }
            }
        }

        function replayCurrentLine() {
            if (!player || !currentVideo || !currentVideo.subtitles) return;
            const subs = currentVideo.subtitles;
            const time = player.getCurrentTime();

            // Reset auto-stop so it will stop again at the end of this line
            lastAutoStoppedIdx = -1;

            // Replay the line we are currently in or the one we just passed
            for (let i = subs.length - 1; i >= 0; i--) {
                if (time >= subs[i].start) {
                    player.seekTo(subs[i].start);
                    player.playVideo();
                    return;
                }
            }
            player.seekTo(0);
            player.playVideo();
        }

        function updateSubtitles() {
            if (!player || !currentVideo || !currentVideo.subtitles) return;

            const time = player.getCurrentTime();
            const subs = currentVideo.subtitles;

            // Find active subtitle
            let activeIdx = -1;
            for (let i = 0; i < subs.length; i++) {
                if (time >= subs[i].start && time <= subs[i].end) {
                    activeIdx = i;
                    break;
                }
            }

            if (autoStopEnabled && activeIdx !== -1) {
                // If we are getting very close to the end of the current subtitle
                // Stop slightly before or exactly at the end rather than waiting for it to leak into the gap
                if (time >= subs[activeIdx].end - 0.05 && lastAutoStoppedIdx !== activeIdx) {
                    player.pauseVideo();
                    player.seekTo(subs[activeIdx].end);
                    lastAutoStoppedIdx = activeIdx;
                }
            }

            // If the user seeks forward or backward, or the line naturally progresses, 
            // reset the auto-stop flag for the new active line.
            if (activeIdx !== lastPlayedIdx) {
                if (activeIdx !== lastAutoStoppedIdx) {
                    lastAutoStoppedIdx = -1;
                }
                lastPlayedIdx = activeIdx;
            }

            if (activeIdx !== activeSubtitleIdx) {
                activeSubtitleIdx = activeIdx;
                const deEl = document.getElementById('subDe');
                const enEl = document.getElementById('subEn');
                const expList = document.getElementById('explanationList');

                if (activeIdx >= 0) {
                    const sub = subs[activeIdx];
                    deEl.textContent = sub.text_de;
                    enEl.textContent = sub.text_en || '';

                    if (sub.chunks && sub.chunks.length > 0) {
                        expList.innerHTML = '';
                        sub.chunks.forEach(chunk => {
                            const li = document.createElement('li');
                            li.innerHTML = `<strong>${chunk.de}</strong> = ${chunk.en}`;
                            expList.appendChild(li);
                        });
                    } else {
                        expList.innerHTML = '<li class="explanation-empty">No word breakdown available for this line</li>';
                    }
                } else {
                    deEl.textContent = '...';
                    enEl.textContent = '';
                    expList.innerHTML = '<li class="explanation-empty">Word breakdown will appear here</li>';
                }
            }
        }

        function toggleAutoStop() {
            autoStopEnabled = !autoStopEnabled;
            const btn = document.getElementById('autoStopBtn');
            if (autoStopEnabled) {
                btn.classList.add('btn-active');
            } else {
                btn.classList.remove('btn-active');
            }
        }



        // Auto-refresh polling: check every 10s if any video is still translating
        let translatingPollTimer = null;

        function startTranslatingPoll() {
            if (translatingPollTimer) return; // already polling
            translatingPollTimer = setInterval(async () => {
                // Only poll if list view is visible
                if (document.getElementById('listView').style.display === 'none') return;
                try {
                    const resp = await fetch('/videos');
                    const data = await resp.json();
                    const updatedVideos = data.videos || [];
                    const stillTranslating = updatedVideos.some(v => v.translating);

                    // Update the grid with fresh data
                    videos = updatedVideos;
                    renderGrid();

                    if (!stillTranslating) {
                        clearInterval(translatingPollTimer);
                        translatingPollTimer = null;
                    }
                } catch (err) {
                    // Silently ignore polling errors
                }
            }, 10000);
        }

        // Start polling if any video is translating after initial load
        async function initApp() {
            await loadVideos();
            if (videos.some(v => v.translating)) {
                startTranslatingPoll();
            }
        }
        initApp();
    </script>
</body>

</html>