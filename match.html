<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<meta name="theme-color" content="#ffffff" />
<meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: dark)" />
<meta name="msapplication-navbutton-color" content="#ffffff" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<title>Match Pairs</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com" rel="preconnect" />
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect" />
<link href="https://fonts.googleapis.com/css2?family=Lexend:wght@400;500;600;700&display=swap" rel="stylesheet" />
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
<script id="tailwind-config">tailwind.config={darkMode:"class",theme:{extend:{colors:{primary:"#007AFF","background-light":"#F9F9F9","background-dark":"#101922","card-light":"#FFFFFF","card-dark":"#19242E","text-primary-light":"#333333","text-primary-dark":"#E5E7EB","text-secondary-light":"#8E8E93","text-secondary-dark":"#92adc9",destructive:"#FF3B30"},fontFamily:{display:[["Lexend","sans-serif"]]},borderRadius:{DEFAULT:"0.25rem",lg:"0.5rem",xl:"0.75rem",full:"9999px"}}}}</script>
<style>
.material-symbols-outlined{font-variation-settings:'FILL' 0,'wght' 400,'GRAD' 0,'opsz' 24}
body{min-height:max(884px,100dvh)}
.loading-overlay{position:fixed;inset:0;z-index:5;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.6);transition:opacity .2s ease}
.loading-overlay.is-active{display:flex}
.loading-dots{display:flex;gap:8px;color:#8E8E93}
.loading-dots span{width:8px;height:8px;border-radius:50%;background:currentColor;opacity:.5;animation:dotPulse 1000ms infinite ease-in-out;will-change:transform,opacity}
.loading-dots span:nth-child(2){animation-delay:150ms}
.loading-dots span:nth-child(3){animation-delay:300ms}
@keyframes dotPulse{0%{transform:scale(1);opacity:.35}50%{transform:scale(1.25);opacity:1}100%{transform:scale(1);opacity:.35}}
@media (prefers-color-scheme: dark){.loading-dots{color:#92adc9}.loading-overlay{background:rgba(0,0,0,.6)}}
.card{border:1px solid #e5e7eb;border-radius:16px;background:#fff}
.card-dark{border-color:#1f2937;background:#19242E}
.pair-btn{height:88px;border:1px solid #e5e7eb;border-radius:10px;background:#f8fafc;color:#333;display:flex;align-items:center;justify-content:center;user-select:none;transition:background-color .36s ease,border-color .36s ease,box-shadow .36s ease}
.pair-btn.active{outline:2px solid #3b82f6;background:#e8f0fe}
.pair-btn.correct{background:#dcfce7;color:#166534;border-color:#86efac}
.pair-btn.wrong{background:#fee2e2;color:#991b1b;border-color:#fecaca}
.pair-text{height:88px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;color:#333;display:flex;align-items:center;justify-content:center;padding:0 10px;transition:background-color .36s ease,border-color .36s ease,box-shadow .36s ease}
.pair-text.active{outline:2px solid #3b82f6;background:#e8f0fe}
.pair-text.correct{background:#dcfce7;color:#166534;border-color:#86efac}
.pair-text.wrong{background:#fee2e2;color:#991b1b;border-color:#fecaca}
@media (prefers-color-scheme: dark){.card{background:#19242E;border-color:#1f2937}.pair-btn{background:#1f2937;color:#E5E7EB;border-color:#374151}.pair-text{background:#0b1220;color:#E5E7EB;border-color:#374151}}
.form-toggle{accent-color:#64748b}
@media (prefers-color-scheme: dark){.form-toggle{accent-color:#9ca3af}}
.fade-out{opacity:0;transition:opacity .36s ease}
.fade-in{opacity:0;transform:translateY(8px);animation:fadeIn .64s ease forwards}
@keyframes fadeIn{0%{opacity:0;transform:translateY(8px)}100%{opacity:1;transform:translateY(0)}}
.no-anim{transition:none!important;animation:none!important}
.disable-interactions{pointer-events:none}
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display">
<div class="relative flex min-h-screen w-full flex-col">
 <header class="sticky top-0 z-10 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm border-b border-slate-200 dark:border-slate-800">
  <div class="mx-auto max-w-md px-3 py-2 flex items-center gap-2">
    <button id="backBtn" class="flex h-8 w-8 items-center justify-center rounded-full text-text-primary-light dark:text-text-primary-dark"><span class="material-symbols-outlined text-xl">close</span></button>
    <div class="flex-1 text-center text-sm font-semibold text-text-secondary-light dark:text-text-secondary-dark" id="progressText">0/0</div>
    <button id="homeBtn" class="flex h-8 w-8 items-center justify-center rounded-full text-text-primary-light dark:text-text-primary-dark" aria-label="Home"><span class="material-symbols-outlined text-xl">home</span></button>
  </div>
 </header>
 <div id="globalLoader" class="loading-overlay" aria-hidden="true"><div class="loading-dots"><span></span><span></span><span></span></div></div>
 <main class="mx-auto max-w-md p-4 w-full">
  <section class="mb-4">
    <label for="deckSelect" class="block text-xs font-semibold text-text-secondary-light dark:text-text-secondary-dark">Deck</label>
    <select id="deckSelect" class="mt-1 w-full rounded-lg border border-slate-300 dark:border-slate-700 bg-card-light dark:bg-card-dark text-text-primary-light dark:text-text-primary-dark"></select>
  </section>
  <section class="card dark:card-dark rounded-xl p-6">
    <h2 class="text-lg font-bold text-text-primary-light dark:text-text-primary-dark mb-3">Select the matching pairs</h2>
    <div class="mb-3 flex items-center gap-2">
      <input id="showGermanToggle" type="checkbox" class="rounded form-toggle" />
      <label for="showGermanToggle" class="text-sm text-text-secondary-light dark:text-text-secondary-dark">Show German words (instead of audio)</label>
    </div>
    <div class="grid grid-cols-2 gap-3">
      <div id="leftCol" class="space-y-3"></div>
      <div id="rightCol" class="space-y-3"></div>
    </div>
    <div id="feedback" class="mt-3 text-sm"></div>
  </section>
 </main>
</div>
<script>
const backBtn=document.getElementById('backBtn');
const homeBtn=document.getElementById('homeBtn');
const deckSelect=document.getElementById('deckSelect');
const leftCol=document.getElementById('leftCol');
const rightCol=document.getElementById('rightCol');
const showGermanToggle=document.getElementById('showGermanToggle');
const progressText=document.getElementById('progressText');
const feedback=document.getElementById('feedback');
try{feedback.hidden=true;}catch{}
const globalLoader=document.getElementById('globalLoader');
function showLoader(){globalLoader.classList.add('is-active')}
function hideLoader(){globalLoader.classList.remove('is-active')}
const params=new URLSearchParams(location.search);let currentDeck=params.get('deck')||'';
let cards=[];let used=new Set();let round=[];let matched=0;let leftSelected=-1;let rightSelected=-1;let pendingIndices=[];let pendingRightIndices=[];let rightOrder=[];let showGermanLeft=false;let matchedIndices=new Set();let matchedTexts=new Set();let isAnimatingWrong=false;
const audio=new Audio();const audioCache=new Map();
function setProgress(){progressText.textContent=`${used.size}/${cards.length}`}
function play(text){const key=`audio:de:${text}`;const ls=localStorage.getItem(key);if(ls){audio.src=ls;}else{const cached=audioCache.get(text);if(cached){audio.src=cached;}else{audio.src=`/tts?text=${encodeURIComponent(text)}&lang=de`;}}audio.play().catch(()=>{try{const u=new SpeechSynthesisUtterance(text);u.lang='de-DE';speechSynthesis.speak(u);}catch{}})}
function hydrateAudioLocal(){round.forEach(c=>{const v=localStorage.getItem(`audio:de:${c.de}`);if(v)audioCache.set(c.de,v);});}
async function preloadRoundAudio(){const tasks=round.map(c=>fetch(`/tts?text=${encodeURIComponent(c.de)}&lang=de`).then(r=>r.blob()).then(b=>{const url=URL.createObjectURL(b);audioCache.set(c.de,url);} ).catch(()=>{}));await Promise.allSettled(tasks)}
function pickRound(){round=[];matched=0;leftSelected=-1;rightSelected=-1;const avail=cards.filter((_,i)=>!used.has(i));const pool=avail.length>=5?5:avail.length;const idxs=[];const options=[...cards.keys()].filter(i=>!used.has(i));for(let i=0;i<pool;i++){const j=Math.floor(Math.random()*options.length);idxs.push(options[j]);options.splice(j,1);}round=idxs.map(i=>cards[i]);}
function renderRound(){leftCol.innerHTML='';rightCol.innerHTML='';round.forEach((c,idx)=>{const btn=document.createElement('button');if(showGermanLeft){btn.className='pair-text w-full';btn.textContent=c.de;btn.addEventListener('click',()=>{leftSelected=idx;updateSelection();checkMatch();});}else{btn.className='pair-btn w-full';btn.innerHTML='<span class="material-symbols-outlined">volume_up</span>';btn.addEventListener('click',()=>{play(c.de);leftSelected=idx;updateSelection();checkMatch();});}if(matchedIndices.has(idx)){btn.classList.add('correct');btn.disabled=true;}leftCol.appendChild(btn);});const texts=round.map(c=>c.en);for(let i=texts.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[texts[i],texts[j]]=[texts[j],texts[i]];}texts.forEach((t,i)=>{const div=document.createElement('button');div.className='pair-text w-full';div.textContent=t;div.addEventListener('click',()=>{rightSelected=i;updateSelection(true,t);checkMatch();});if(matchedTexts.has(t)){div.classList.add('correct');div.disabled=true;}rightCol.appendChild(div);});rightOrder=texts.slice();hydrateAudioLocal();preloadRoundAudio();}
function updateSelection(isRight=false,text=''){const l=Array.from(leftCol.children);l.forEach((el,i)=>{el.classList.toggle('active',i===leftSelected)});const r=Array.from(rightCol.children);r.forEach((el)=>{el.classList.remove('active')});if(isRight){r.forEach(el=>{if(el.textContent===text)el.classList.add('active')});}}
function clearActive(){Array.from(leftCol.children).forEach(el=>el.classList.remove('active'));Array.from(rightCol.children).forEach(el=>el.classList.remove('active'));}
function checkMatch(){if(leftSelected<0||rightSelected<0)return;const leftCard=round[leftSelected];const rightText=Array.from(rightCol.children)[rightSelected].textContent;const ok=rightText===leftCard.en;if(ok){Array.from(leftCol.children)[leftSelected].classList.add('correct');Array.from(rightCol.children)[rightSelected].classList.add('correct');Array.from(leftCol.children)[leftSelected].disabled=true;Array.from(rightCol.children)[rightSelected].disabled=true;matched++;pendingIndices.push(leftSelected);pendingRightIndices.push(rightSelected);matchedIndices.add(leftSelected);matchedTexts.add(rightText);clearActive();const originalIndex=cards.findIndex(c=>c.en===leftCard.en&&c.de===leftCard.de);if(originalIndex>=0)used.add(originalIndex);if(matched>=3){replaceAfterThree();} } else {const lEl=Array.from(leftCol.children)[leftSelected];const rEl=Array.from(rightCol.children)[rightSelected];clearActive();isAnimatingWrong=true;Array.from(leftCol.children).forEach(el=>{if(el!==lEl)el.classList.add('no-anim')});Array.from(rightCol.children).forEach(el=>{if(el!==rEl)el.classList.add('no-anim')});if(lEl)lEl.classList.add('wrong');if(rEl)rEl.classList.add('wrong');setTimeout(()=>{try{if(lEl)lEl.classList.remove('wrong');if(rEl)rEl.classList.remove('wrong');Array.from(leftCol.children).forEach(el=>el.classList.remove('no-anim'));Array.from(rightCol.children).forEach(el=>el.classList.remove('no-anim'));isAnimatingWrong=false;}catch{Array.from(leftCol.children).forEach(el=>el.classList.remove('no-anim'));Array.from(rightCol.children).forEach(el=>el.classList.remove('no-anim'));isAnimatingWrong=false;}},3000);}leftSelected=-1;rightSelected=-1;}
function replaceAfterThree(){const leftNodes=Array.from(leftCol.children);const rightNodes=Array.from(rightCol.children);
  const options=[...cards.keys()].filter(i=>!used.has(i)&&!pendingIndices.includes(i));
  const count=Math.min(pendingIndices.length,options.length);
  if(count===0 && used.size>=cards.length){showDone();return;}
  // fade out matched items only
  for(let i=0;i<count;i++){const lIdx=pendingIndices[i];const rIdx=pendingRightIndices[i];if(leftNodes[lIdx])leftNodes[lIdx].classList.add('fade-out');if(rightNodes[rIdx])rightNodes[rIdx].classList.add('fade-out');}
  setTimeout(()=>{
    // replace in place
    for(let i=0;i<count;i++){
      const pickIndex=Math.floor(Math.random()*options.length);
      const newCard=cards[options[pickIndex]];options.splice(pickIndex,1);
      const lIdx=pendingIndices[i];const rIdx=pendingRightIndices[i];
      round[lIdx]=newCard;
      // left element
      const oldL=leftNodes[lIdx];
      const newL=document.createElement('button');
      if(showGermanLeft){newL.className='pair-text w-full';newL.textContent=newCard.de;newL.addEventListener('click',()=>{leftSelected=lIdx;updateSelection();checkMatch();});}
      else {newL.className='pair-btn w-full';newL.innerHTML='<span class="material-symbols-outlined">volume_up</span>';newL.addEventListener('click',()=>{play(newCard.de);leftSelected=lIdx;updateSelection();checkMatch();});}
      newL.classList.add('fade-in');
      oldL.replaceWith(newL);
      // right element
      const oldR=rightNodes[rIdx];
      const newR=document.createElement('button');
      newR.className='pair-text w-full';
      newR.textContent=newCard.en;
      newR.addEventListener('click',()=>{rightSelected=rIdx;updateSelection(true,newCard.en);checkMatch();});
      newR.classList.add('fade-in');
      oldR.replaceWith(newR);
      rightOrder[rIdx]=newCard.en;
    }
    setTimeout(()=>{Array.from(leftCol.children).forEach(el=>el.classList.remove('fade-in'));Array.from(rightCol.children).forEach(el=>el.classList.remove('fade-in'));},720);
    matched=0;pendingIndices=[];pendingRightIndices=[];matchedIndices.clear();matchedTexts.clear();setProgress();
    hydrateAudioLocal();preloadRoundAudio();
  },400);
}
function showDone(){leftCol.innerHTML='';rightCol.innerHTML='';feedback.hidden=false;feedback.textContent='Done â€” all pairs completed!';feedback.className='mt-6 text-base font-semibold text-green-600 dark:text-green-400'}
function nextRound(){if(used.size>=cards.length){showDone();return;}pickRound();renderRound();setProgress();}
async function loadDecks(){showLoader();try{const resp=await fetch('/decks');const list=await resp.json();deckSelect.innerHTML='';const ph=document.createElement('option');ph.value='';ph.textContent='Select a deck';deckSelect.appendChild(ph);list.forEach(d=>{const opt=document.createElement('option');opt.value=d.name;opt.textContent=d.name;deckSelect.appendChild(opt);});if(currentDeck){deckSelect.value=currentDeck;} }catch{const ph=document.createElement('option');ph.value='';ph.textContent='No decks';deckSelect.appendChild(ph);}finally{hideLoader();}}
async function loadCards(name){showLoader();try{const resp=await fetch(`/cards?deck=${encodeURIComponent(name)}`);const data=await resp.json();cards=Array.isArray(data)?data:[];used.clear();pickRound();renderRound();setProgress();try{feedback.hidden=true;feedback.textContent='';}catch{} }catch{cards=[];used.clear();leftCol.innerHTML='';rightCol.innerHTML='';}finally{hideLoader();}}
backBtn.addEventListener('click',()=>{history.length>1?history.back():location.href='/'});
homeBtn.addEventListener('click',()=>{location.href='/'});
deckSelect.addEventListener('change',e=>{currentDeck=e.target.value;loadCards(currentDeck)});
function animateToggleSwap(){const nodes=Array.from(leftCol.children);nodes.forEach((oldEl,idx)=>{oldEl.classList.add('fade-out');});setTimeout(()=>{nodes.forEach((oldEl,idx)=>{const c=round[idx];const newBtn=document.createElement('button');if(showGermanLeft){newBtn.className='pair-text w-full';newBtn.textContent=c.de;newBtn.addEventListener('click',()=>{leftSelected=idx;updateSelection();checkMatch();});}else{newBtn.className='pair-btn w-full';newBtn.innerHTML='<span class="material-symbols-outlined">volume_up</span>';newBtn.addEventListener('click',()=>{play(c.de);leftSelected=idx;updateSelection();checkMatch();});}if(matchedIndices.has(idx)){newBtn.classList.add('correct');newBtn.disabled=true;}newBtn.classList.add('fade-in');oldEl.replaceWith(newBtn);});setTimeout(()=>{Array.from(leftCol.children).forEach(el=>el.classList.remove('fade-in'));},720);},360);} 
showGermanToggle.addEventListener('change',()=>{if(isAnimatingWrong){showGermanToggle.checked=showGermanLeft;return;}showGermanLeft=showGermanToggle.checked;try{localStorage.setItem('matchShowGermanLeft',showGermanLeft?'1':'0');}catch{}animateToggleSwap();});
function shouldClear(t){if(t.closest('.pair-btn,.pair-text'))return false;if(t.closest('#showGermanToggle'))return false;if(t.closest('#deckSelect'))return false;return true}
document.addEventListener('click',(e)=>{if(isAnimatingWrong)return;const t=e.target;if(!shouldClear(t))return;clearActive();leftSelected=-1;rightSelected=-1;});
// initialize toggle state
try{showGermanLeft=(localStorage.getItem('matchShowGermanLeft')==='1');}catch{showGermanLeft=false}
showGermanToggle.checked=showGermanLeft;
loadDecks();if(currentDeck)loadCards(currentDeck);
</script>
</body>
</html>